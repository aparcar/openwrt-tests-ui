<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>OpenWrt Test Dashboard - Development Snapshots</title>

        <!-- Bootstrap CSS -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <!-- Bootstrap Icons -->
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
        />

        <!-- Custom CSS -->
        <link rel="stylesheet" href="../css/styles.css" />
    </head>

    <body>
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg">
            <div class="container-fluid">
                <a class="navbar-brand fw-bold" href="../index.html">
                    <i class="bi bi-router-fill me-2"></i>
                    OpenWrt Test Dashboard
                </a>
                <div class="navbar-nav ms-auto">
                    <a href="../index.html" class="nav-link">
                        <i class="bi bi-arrow-left me-1"></i>
                        Back to Overview
                    </a>
                    <span class="navbar-text text-white-50 ms-3">
                        Development Snapshots
                    </span>
                    <button
                        class="btn btn-outline-light btn-sm ms-3"
                        onclick="deviceManager.refresh()"
                        id="refreshBtn"
                    >
                        <i class="bi bi-arrow-clockwise"></i>
                        Refresh
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Container -->
        <div class="container-fluid mt-4">
            <!-- Last Update Info -->
            <div class="row mb-3">
                <div class="col-12 text-center">
                    <small class="text-muted" id="last-update">
                        <!-- Last update time will be shown here -->
                    </small>
                </div>
            </div>

            <!-- Statistics Row -->
            <div class="row mb-4" id="stats-container">
                <!-- Stats will be loaded here -->
            </div>

            <!-- Search and Filter Container -->
            <div class="search-container">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-search"></i>
                            </span>
                            <input
                                type="text"
                                class="form-control"
                                id="searchInput"
                                placeholder="Search by device name or model..."
                                onkeyup="handleSearch()"
                            />
                        </div>
                    </div>
                    <div class="col-md-6 mt-2 mt-md-0">
                        <div class="btn-group" role="group">
                            <input
                                type="radio"
                                class="btn-check"
                                name="filterOptions"
                                id="filterAll"
                                value="all"
                                checked
                                onchange="handleFilter()"
                            />
                            <label
                                class="btn btn-outline-primary"
                                for="filterAll"
                            >
                                All Devices
                            </label>

                            <input
                                type="radio"
                                class="btn-check"
                                name="filterOptions"
                                id="filterFailed"
                                value="failed"
                                onchange="handleFilter()"
                            />
                            <label
                                class="btn btn-outline-danger"
                                for="filterFailed"
                            >
                                Failed Tests Only
                            </label>
                        </div>
                        <span class="filter-badge" id="filterCount">
                            <!-- Count will be shown here -->
                        </span>
                    </div>
                </div>
            </div>

            <!-- Error Container -->
            <div id="error-container"></div>

            <!-- Device List Container -->
            <div id="device-container">
                <div class="text-center py-5">
                    <div class="loading-spinner"></div>
                    <p class="mt-2 text-muted">Loading devices...</p>
                </div>
            </div>
        </div>

        <!-- Modal for device details -->
        <div
            class="modal fade"
            id="deviceModal"
            tabindex="-1"
            aria-hidden="true"
        >
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalTitle">
                            Device Details
                        </h5>
                        <button
                            type="button"
                            class="btn-close btn-close-white"
                            data-bs-dismiss="modal"
                            aria-label="Close"
                        ></button>
                    </div>
                    <div class="modal-body" id="modal-content">
                        <!-- Content will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Bootstrap JS Bundle -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

        <!-- Custom JavaScript -->
        <script src="../js/utils.js"></script>
        <script src="../js/devices.js"></script>

        <script>
            // Global device manager instance
            let deviceManager;

            // Debounced search handler
            const handleSearch = Utils.debounce(() => {
                const searchTerm = document.getElementById("searchInput").value;
                const filterType = document.querySelector(
                    'input[name="filterOptions"]:checked',
                ).value;
                deviceManager.filterDevices(searchTerm, filterType);
            }, 300);

            // Filter handler
            function handleFilter() {
                const searchTerm = document.getElementById("searchInput").value;
                const filterType = document.querySelector(
                    'input[name="filterOptions"]:checked',
                ).value;
                deviceManager.filterDevices(searchTerm, filterType);
            }

            // Initialize the application
            document.addEventListener("DOMContentLoaded", function () {
                // Create device manager instance for snapshot version
                deviceManager = new DeviceManager(CONFIG.BASE_URL, "snapshot");

                // Load devices
                deviceManager.loadDevices().catch((error) => {
                    console.error("Failed to load devices:", error);
                });

                // Set up auto-refresh
                setInterval(() => {
                    deviceManager.refresh().catch((error) => {
                        console.warn("Auto-refresh failed:", error);
                    });
                }, CONFIG.REFRESH_INTERVAL);

                // Handle browser back/forward buttons
                window.addEventListener("popstate", function (event) {
                    const params = Utils.getUrlParams();
                    if (params.search) {
                        document.getElementById("searchInput").value =
                            params.search;
                    }
                    if (params.filter) {
                        const filterRadio = document.getElementById(
                            `filter${params.filter.charAt(0).toUpperCase() + params.filter.slice(1)}`,
                        );
                        if (filterRadio) {
                            filterRadio.checked = true;
                        }
                    }
                    handleFilter();
                });

                // Update URL when filtering/searching
                const originalFilterDevices =
                    deviceManager.filterDevices.bind(deviceManager);
                deviceManager.filterDevices = function (
                    searchTerm,
                    filterType,
                ) {
                    originalFilterDevices(searchTerm, filterType);
                    Utils.updateUrl({
                        search: searchTerm || null,
                        filter: filterType === "all" ? null : filterType,
                    });
                };

                // Initialize from URL parameters
                const params = Utils.getUrlParams();
                if (params.search) {
                    document.getElementById("searchInput").value =
                        params.search;
                }
                if (params.filter) {
                    const filterRadio = document.getElementById(
                        `filter${params.filter.charAt(0).toUpperCase() + params.filter.slice(1)}`,
                    );
                    if (filterRadio) {
                        filterRadio.checked = true;
                    }
                }
            });

            // Keyboard shortcuts
            document.addEventListener("keydown", function (event) {
                // Ctrl/Cmd + K to focus search
                if ((event.ctrlKey || event.metaKey) && event.key === "k") {
                    event.preventDefault();
                    document.getElementById("searchInput").focus();
                }

                // F5 or Ctrl/Cmd + R to refresh
                if (
                    event.key === "F5" ||
                    ((event.ctrlKey || event.metaKey) && event.key === "r")
                ) {
                    event.preventDefault();
                    deviceManager.refresh();
                }

                // Escape to clear search
                if (event.key === "Escape") {
                    const searchInput = document.getElementById("searchInput");
                    if (document.activeElement === searchInput) {
                        searchInput.value = "";
                        handleSearch();
                        searchInput.blur();
                    }
                }
            });
        </script>
    </body>
</html>
